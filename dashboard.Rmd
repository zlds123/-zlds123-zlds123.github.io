---
title: "flexdashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE, echo=FALSE, warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='last'}
library(flexdashboard)
```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart A

```{r, echo=FALSE, warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='last'}
library(readr)
library(dplyr)
library(reshape2)
library(lubridate)
library(ggplot2)
library(maps)
library(ggthemes)
library(gganimate)
```


```{r, echo=FALSE, warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='last'}
covid = read_csv("/Users/zhiyulin/Desktop/final_project/COVID-19/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")
covid_df = melt(covid, id.vars = c("Province/State", "Country/Region", "Lat", "Long"))
covid_df$variable <- mdy(covid_df$variable)
drops <- c("Province/State")
covid_df <- covid_df[ , !(names(covid_df) %in% drops)]
colnames(covid_df) <- c("Country", "Lat", "Long", "Date", "Cases")
covid_df <- covid_df[complete.cases(covid_df), ]
covid_df$cases10k <- covid_df$Cases / 10000
covid_df <- covid_df %>% group_by(Country, Date) %>% summarise(sum(Cases))
colnames(covid_df) = c("Country", "Date", "Cases")
exp <- covid_df %>%
  filter(Country %in% c("China", "US", "Argentina","Japan", "Brazil", "Italy", "France", "India", "Russia"))
fancy_scientific <- function(l) {
     # turn in to character string in scientific notation
     l <- format(l, scientific = TRUE)
     # quote the part before the exponent to keep all the digits
     l <- gsub("^(.*)e", "'\\1'e", l)
     # turn the 'e+' into plotmath format
     l <- gsub("e", "%*%10^", l)
     # return this as an expression
     parse(text=l)
}

ggplot() +
    geom_line(data=covid_df, aes(x=Date, y=Cases, group = Country), colour = "gray78", show.legend = F) +
    geom_line(data=exp, aes(x=Date, y=Cases, group = Country, colour = Country)) + theme_minimal() +
   scale_y_continuous(labels=fancy_scientific)
```

### Chart B

```{r, echo=FALSE, warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='last'}
covid2 = read_csv("/Users/zhiyulin/Desktop/final_project/COVID-19/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")
covid_death = melt(covid2, id.vars = c("Province/State", "Country/Region", "Lat", "Long"))
covid_death$variable <- mdy(covid_death$variable)
drops <- c("Province/State")
covid_death <- covid_death[ , !(names(covid_death) %in% drops)]
colnames(covid_death) <- c("Country", "Lat", "Long", "Date", "Cases")
covid_death <- covid_death[complete.cases(covid_death), ]
covid_death$cases10k <- covid_death$Cases / 10000
covid_death <- covid_death %>% group_by(Country, Date) %>% summarise(sum(Cases))
colnames(covid_death) = c("Country", "Date", "Cases")
exp_death <- covid_death %>%
  filter(Country %in% c("China", "US", "Argentina","Japan", "Brazil", "Italy", "France", "India", "Russia"))

covid3 = read_csv("/Users/zhiyulin/Desktop/final_project/COVID-19/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv")
covid_rec = melt(covid3, id.vars = c("Province/State", "Country/Region", "Lat", "Long"))
covid_rec$variable <- mdy(covid_rec$variable)
drops <- c("Province/State")
covid_rec <- covid_rec[ , !(names(covid_rec) %in% drops)]
colnames(covid_rec) <- c("Country", "Lat", "Long", "Date", "Cases")
covid_rec <- covid_rec[complete.cases(covid_rec), ]
covid_rec$cases10k <- covid_rec$Cases / 10000
covid_rec <- covid_rec %>% group_by(Country, Date) %>% summarise(sum(Cases))
colnames(covid_rec) = c("Country", "Date", "Cases")
exp_rec <- covid_rec %>%
  filter(Country %in% c("China", "US", "Argentina","Japan", "Brazil", "Italy", "France", "India", "Russia"))

exp$category = "confirmed cases"
exp_death$category = "death"
exp_rec$category = "recovered cases"
exp_all = rbind(exp, exp_death, exp_rec)
exp_all_2 <- exp_all %>%
  group_by(Country, category, Date) %>%
  summarise(sum(Cases))
colnames(exp_all_2) = c("Country", "category", "Date", "Cases")

ggplot(exp_all_2, aes(Date, Cases)) +
  geom_line(size=1, aes(color=category)) +
  facet_wrap(vars(Country), labeller = "label_both", scales = "free") +
  scale_y_continuous(labels=fancy_scientific) + 
  theme_minimal()
```

### Chart C

```{r, echo=FALSE, warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='last'}
ggplot(exp_all_2, aes(Date, Cases)) +
  geom_line(size=1, aes(color=category)) +
  facet_wrap(vars(Country), labeller = "label_both") +
  scale_y_continuous(labels=fancy_scientific) + 
  theme_minimal()
```


Column {data-width=350}
-----------------------------------------------------------------------

### Chart D

```{r, eval=FALSE, echo=FALSE, warning=FALSE,message=FALSE,error=FALSE, results='hide',fig.keep='last'}
# confirmed cases
covid = read_csv("/Users/zhiyulin/Desktop/final_project/COVID-19/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")
covid_df = melt(covid, id.vars = c("Province/State", "Country/Region", "Lat", "Long"))
covid_df$variable <- mdy(covid_df$variable)
drops <- c("Province/State")
covid_df <- covid_df[ , !(names(covid_df) %in% drops)]
colnames(covid_df) <- c("Country", "Lat", "Long", "Date", "Cases")
covid_df <- covid_df[complete.cases(covid_df), ]
covid_df <- covid_df %>% group_by(Country, Date) %>% summarise(sum(Cases), mean(Lat), mean(Long))
colnames(covid_df) = c("Country", "Date", "Cases", "Lat", "Long")
sub_covid_df = covid_df %>%
  slice(which(row_number() %% 10 == 1))

# deaths
covid2 = read_csv("/Users/zhiyulin/Desktop/final_project/COVID-19/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")
covid_df2 = melt(covid2, id.vars = c("Province/State", "Country/Region", "Lat", "Long"))
covid_df2$variable <- mdy(covid_df2$variable)
drops <- c("Province/State")
covid_df2 <- covid_df2[ , !(names(covid_df2) %in% drops)]
colnames(covid_df2) <- c("Country", "Lat", "Long", "Date", "Cases")
covid_df2 <- covid_df2[complete.cases(covid_df2), ]
covid_df2 <- covid_df2 %>% group_by(Country, Date) %>% summarise(sum(Cases), mean(Lat), mean(Long))
colnames(covid_df2) = c("Country", "Date", "Cases", "Lat", "Long")
sub_covid_df2 = covid_df2 %>%
  slice(which(row_number() %% 10 == 1))

# recovered
covid3 = read_csv("/Users/zhiyulin/Desktop/final_project/COVID-19/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv")
covid_df3 = melt(covid3, id.vars = c("Province/State", "Country/Region", "Lat", "Long"))
covid_df3$variable <- mdy(covid_df3$variable)
drops <- c("Province/State")
covid_df3 <- covid_df3[ , !(names(covid_df3) %in% drops)]
colnames(covid_df3) <- c("Country", "Lat", "Long", "Date", "Cases")
covid_df3 <- covid_df3[complete.cases(covid_df), ]
covid_df3 <- covid_df3 %>% group_by(Country, Date) %>% summarise(sum(Cases), mean(Lat), mean(Long))
colnames(covid_df3) = c("Country", "Date", "Cases", "Lat", "Long")
sub_covid_df3 = covid_df3 %>%
  slice(which(row_number() %% 10 == 1))

# finalize the dataframe
sub_covid_df$category = "confirmed cases"
sub_covid_df2$category = "death"
sub_covid_df3$category = "recovered cases"
sub_all = rbind(sub_covid_df, sub_covid_df2, sub_covid_df3)

# facet + animation
map_frames_all <- 
  ggplot(data = sub_all, aes(frame=Date, x = Long, y = Lat, size = Cases, color=category)) +
  borders("world", colour = "gray85", fill = "gray80") +
  theme_map() +
  geom_point(alpha = .4) +
  scale_size_continuous(range = c(1, 18)) +
  facet_wrap(vars(category), labeller = "label_both") 
  theme(plot.margin=unit(c(1,1,4,0.5),"cm")) +
  theme(legend.position=c(0.85,-0.7))

map_frames_all +  transition_states(Date) + shadow_mark()
```

![](dashboard_files/figure-html/unnamed-chunk-5-1.gif)

### Chart E

```{r}

```


